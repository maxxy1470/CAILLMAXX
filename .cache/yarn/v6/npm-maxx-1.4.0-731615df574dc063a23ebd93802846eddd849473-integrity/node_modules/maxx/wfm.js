const axios = require("axios");
const parseString = require("xml2js").parseString;
const config = require("./config");

const apiKey = () => config.get("WFM_APIKEY");
const accountKey = () => config.get("WFM_ACCOUNTKEY");

const formatOpts = options =>
  Object.keys(options).reduce((a, b) => `${a}&${b}=${options[b]}`, "");

const get = (url, options) =>
  axios
    .get(
      `https://api.workflowmax.com${url}?apiKey=${apiKey()}&accountKey=${accountKey()}${formatOpts(
        options || {}
      )}`
    )
    .catch(err => {
      console.log("Invalid credentials");
      //TODO handle this better
      process.exit(1);
    })
    .then(x => x.data)
    .then(
      users =>
        new Promise((resolve, reject) =>
          parseString(users, (err, obj) => (err ? reject(err) : resolve(obj)))
        )
    );

const post = (url, data, options) =>
  axios
    .post(
      `https://api.workflowmax.com${url}?apiKey=${apiKey()}&accountKey=${accountKey()}${formatOpts(
        options || {}
      )}`,
      data
    )
    .catch(err => {
      console.log("Invalid credentials");
      //TODO handle this better
      process.exit(1);
    })
    .then(x => x.data)
    .then(
      users =>
        new Promise((resolve, reject) =>
          parseString(users, (err, obj) => (err ? reject(err) : resolve(obj)))
        )
    );

module.exports = {
  get,
  post
};
